<?php if ($this->imagemService) :?>
        $this->getImagemService()->appendPlugin();
<?php endif;?>

        $identifier = $this->getEvent()->getRouteMatch()->getParam('id', null);

        if (!$identifier) {
            return $this->redirect()->toRoute(self::LISTS);
        }
        $form = $this->get<?= $this->data?>Factory();

        $redirectUrl = $this->url()->fromRoute(self::EDIT, array('id' => $identifier));
        $prg = $this->prg($redirectUrl, true);

        if ($prg instanceof Response) {
            return $prg;
        } elseif ($prg !== false) {
            $post = $prg;

            $form->setData($post);

            if ($form->isValid()) {

                $data = $form->getData();
                $service = $this->get<?= $this->data?>Service();
<?php if ($this->imagemService) :?>
                $update = $service->update($identifier, $data, $prg);
<?php else:?>
                $update = $service->update($identifier, $data);
<?php endif;?>

                if ($update) {
<?php if ($this->imagemService) :?>
                    $this->getImagemService()->clearCache();
<?php endif;?>
                    return $this->redirect()->toRoute(
                        self::EDIT,
                        array('id' => $update->getId<?= $this->data?>(), 'success' => 1)
                    );
                }
            }
        } else {
            $data = $this->get<?= $this->data?>Service()->selectById($identifier);
            $form->bind($data);
        }


        $sucesso = $this->getEvent()->getRouteMatch()->getParam('success', null);

        return new ViewModel(
            array(
                'form' => $form,
                'success' => $sucesso,
<?php if ($this->imagemService) :?>
                'contexto' => '<?php echo $this->str('url', $this->data);?>',
<?php endif; ?>
                'id<?= $this->data?>' => $identifier
            )
        );